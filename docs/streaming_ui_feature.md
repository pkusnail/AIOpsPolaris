# 流式UI状态显示功能

## 概述

实现了Web UI中RCA分析过程的实时状态显示功能，用户可以看到分析的每个阶段进度和详细信息。

## 技术实现

### 1. 后端架构

#### 任务状态管理器 (`src/utils/task_manager.py`)
- **TaskManager**: 管理所有RCA分析任务的生命周期
- **TaskStage**: 定义分析阶段（NER、搜索、拓扑、推理、格式化）
- **TaskInfo**: 跟踪任务整体状态和进度

#### 流式RCA服务 (`src/api/streaming_rca_service.py`)
- **StreamingRCAService**: 异步执行RCA分析，实时更新进度
- 5个分析阶段权重分配：
  - NER实体识别: 10%
  - 混合搜索: 30% 
  - 拓扑查询: 20%
  - Agent推理分析: 30%
  - 结果格式化: 10%

#### API端点 (`src/api/main.py`)
- `POST /chat/stream`: 启动RCA分析任务，返回task_id
- `GET /chat/task_status/{task_id}`: 获取任务实时状态

### 2. 前端架构

#### 长轮询实现 (`web_ui.html`)
- 每500ms轮询任务状态
- 最大轮询时间120次（2分钟）
- 实时更新进度条和状态显示
- 错误时自动回退到传统模式

#### UI组件
- 进度条显示整体完成度
- 阶段指示器显示当前执行阶段
- 详细状态显示当前操作
- CSS动画提供视觉反馈

## 功能特性

### 实时进度显示
- **整体进度**: 0-100%进度条
- **当前阶段**: 5个分析阶段状态
- **详细状态**: 当前操作的具体描述
- **时间估算**: 预计剩余时间

### 错误处理
- 任务创建失败时回退到传统聊天模式
- 轮询超时时显示超时信息
- Agent推理失败时使用备用分析

### 结果展示
- 完整的RCA分析报告
- 证据文件列表和置信度
- 服务拓扑关系图
- 处理时间统计

## 测试验证

### API测试
```bash
# 创建任务
curl -X POST "http://localhost:8000/chat/stream" \
  -H "Content-Type: application/json" \
  -d '{"message": "service-b CPU使用率异常高", "user_id": "test_user"}'

# 查询状态  
curl -X GET "http://localhost:8000/chat/task_status/{task_id}"
```

### 性能指标
- **任务创建**: ~50ms
- **NER识别**: ~1ms
- **混合搜索**: ~200ms
- **拓扑查询**: ~10ms
- **Agent推理**: ~1.5s
- **总耗时**: ~2-3秒

## 使用说明

1. 用户在Web UI输入RCA查询
2. 系统检测支持流式显示，自动启动streaming模式
3. 界面显示实时进度和阶段信息
4. 完成后展示完整分析结果
5. 失败时自动回退到传统模式

## 配置参数

- **轮询间隔**: 500ms
- **轮询超时**: 120次（2分钟）
- **任务保留时间**: 1小时
- **最大并发任务**: 无限制（异步处理）

## 后续改进

1. WebSocket连接替代长轮询
2. 任务优先级管理
3. 分布式任务调度
4. 缓存常见查询结果
5. 用户自定义轮询间隔