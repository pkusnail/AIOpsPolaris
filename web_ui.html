<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOps Polaris 智能运维助手</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 900px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin-bottom: 10px;
            font-size: 1.8em;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            background: #f8f9fa;
            scroll-behavior: smooth;
            max-height: 60vh;
            min-height: 400px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            max-width: 85%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
        }
        
        .user-message {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        
        .bot-message {
            background: #e9ecef;
            color: #333;
        }
        
        .bot-content {
            margin-top: 5px;
        }
        
        .bot-content h3 {
            color: #667eea;
            margin: 10px 0 5px 0;
            font-size: 1.1em;
        }
        
        .bot-content strong {
            color: #333;
        }
        
        .bot-content pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .message-input:focus {
            border-color: #667eea;
        }
        
        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        
        .send-btn:hover {
            transform: translateY(-2px);
        }
        
        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-bar {
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 0.85em;
            color: #666;
        }
        
        .loading {
            color: #667eea;
            font-style: italic;
        }
        
        .error {
            color: #dc3545;
        }
        
        .success {
            color: #28a745;
        }

        .sidebar {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-width: 250px;
        }
        
        .sidebar h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1em;
        }
        
        .sidebar button {
            width: 100%;
            margin-bottom: 8px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .sidebar button:hover {
            background: #f8f9fa;
        }
        
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* 加载动画 */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 AIOps Polaris</h1>
            <p>基于RAG + 混合搜索 + 多Agent架构的智能运维助手</p>
        </div>
        
        <div class="chat-container">
            <div class="messages" id="messages"></div>
            
            <div class="input-container">
                <input 
                    type="text" 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="输入您的运维问题..."
                    onkeypress="handleKeyPress(event)"
                >
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">发送</button>
            </div>
            
        </div>
        
        <div class="status-bar">
            <span id="statusText">🟢 系统已连接</span>
        </div>
    </div>

    <div class="sidebar">
        <h3>🔧 快捷操作</h3>
        <button onclick="checkHealth()">🔍 系统状态</button>
        <button onclick="getStats()">📊 数据统计</button>
        <button onclick="searchKnowledge()">🔍 搜索知识库</button>
        <button onclick="clearChat()">🗑️ 清空对话</button>
        
        <h3 style="margin-top: 15px;">💡 示例问题</h3>
        <button onclick="askExample('service-b CPU使用率过高，响应超时，请分析根本原因')">Service-B CPU过载</button>
        <button onclick="askExample('service-d1 内存泄漏问题，请帮我分析')">Service-D1内存问题</button>
        <button onclick="askExample('数据库连接失败，多个服务无法访问')">数据库连接问题</button>
        <button onclick="askExample('分析incident_001中的故障根因')">分析日志故障</button>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        // 添加请求拦截器处理CORS
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    mode: 'cors',
                    credentials: 'omit',
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        ...options.headers
                    }
                });
                return response;
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const statusText = document.getElementById('statusText');
        
        let userId = 'web_user_' + Date.now();

        function updateStatus(message, type = 'info') {
            const emoji = type === 'error' ? '❌' : type === 'loading' ? '🔄' : '🟢';
            statusText.innerHTML = `${emoji} ${message}`;
            statusText.className = type;
        }

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            // 检查用户是否正在查看历史消息
            const wasAtBottom = messagesContainer.scrollTop + messagesContainer.clientHeight >= messagesContainer.scrollHeight - 10;
            
            if (isUser) {
                messageDiv.innerHTML = `<strong>👤 您:</strong><br>${escapeHtml(content)}`;
            } else {
                // 对于机器人回复，支持简单的Markdown格式
                const formattedContent = formatBotMessage(content);
                messageDiv.innerHTML = `<strong>🤖 AIOps助手:</strong><br><div class="bot-content">${formattedContent}</div>`;
            }
            
            messagesContainer.appendChild(messageDiv);
            
            // 只有当用户在底部时才自动滚动，或者是用户发送的新消息
            if (wasAtBottom || isUser) {
                setTimeout(() => {
                    messagesContainer.scrollTo({
                        top: messagesContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }

        function formatBotMessage(content) {
            // 转换简单的Markdown格式
            let formatted = escapeHtml(content);
            
            // 处理标题
            formatted = formatted.replace(/^## (.+)$/gm, '<h3 style="color: #667eea; margin: 10px 0 5px 0;">$1</h3>');
            formatted = formatted.replace(/^\*\*(.+)\*\*:/gm, '<strong style="color: #333;">$1:</strong>');
            
            // 处理列表
            formatted = formatted.replace(/^- (.+)$/gm, '• $1<br>');
            formatted = formatted.replace(/^  • (.+)$/gm, '&nbsp;&nbsp;• $1<br>');
            
            // 处理代码块
            formatted = formatted.replace(/```([^`]+)```/g, '<pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; overflow-x: auto;">$1</pre>');
            
            // 处理换行
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // 防止重复发送
            if (sendBtn.disabled) return;

            addMessage(message, true);
            messageInput.value = '';
            sendBtn.disabled = true;
            messageInput.disabled = true;
            
            // 默认使用Multi-Agent模式
            currentTaskId = null; // 重置当前任务ID
            return await sendMultiAgentMessage(message);
            
            // 创建进度显示元素
            const progressDiv = document.createElement('div');
            progressDiv.className = 'message bot-message';
            progressDiv.innerHTML = `
                <strong>🤖 AIOps助手:</strong><br>
                <div class="bot-content">
                    <div id="progress-container" style="margin: 10px 0;">
                        <div style="background: #f0f0f0; border-radius: 10px; padding: 15px;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <div class="spinner" style="margin-right: 10px;"></div>
                                <span id="current-stage">正在启动RCA分析...</span>
                            </div>
                            <div id="progress-bar" style="background: #e0e0e0; height: 8px; border-radius: 4px; margin: 10px 0;">
                                <div id="progress-fill" style="background: #667eea; height: 100%; width: 0%; border-radius: 4px; transition: width 0.3s;"></div>
                            </div>
                            <div id="progress-text">0% 完成</div>
                            <div id="stages-info" style="margin-top: 10px; font-size: 0.85em; color: #666;">
                                <div>🔄 NER实体识别 - 等待中</div>
                                <div>🔄 混合搜索 - 等待中</div>
                                <div>🔄 拓扑查询 - 等待中</div>
                                <div>🔄 Agent推理 - 等待中</div>
                                <div>🔄 结果格式化 - 等待中</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(progressDiv);

            try {
                // 首先启动流式任务
                updateStatus('启动RCA分析任务...', 'loading');
                
                const streamResponse = await apiRequest(`${API_BASE_URL}/chat/stream`, {
                    method: 'POST',
                    body: JSON.stringify({
                        message: message,
                        user_id: userId,
                        temperature: 0.7
                    })
                });

                if (!streamResponse.ok) {
                    throw new Error(`HTTP ${streamResponse.status}: ${streamResponse.statusText}`);
                }

                const streamResult = await streamResponse.json();
                const taskId = streamResult.task_id;
                
                updateStatus(`任务已启动 (ID: ${taskId.slice(-8)}), 正在分析...`, 'loading');
                
                // 开始轮询任务状态
                await pollTaskStatus(taskId, progressDiv);
                
            } catch (error) {
                console.error('Streaming chat request failed:', error);
                
                // 移除进度显示，显示错误信息
                messagesContainer.removeChild(progressDiv);
                addMessage(`连接错误: ${error.message}. 正在尝试使用传统方式...`, false);
                
                // 回退到传统聊天方式
                try {
                    updateStatus('使用传统方式处理...', 'loading');
                    const fallbackResponse = await apiRequest(`${API_BASE_URL}/chat`, {
                        method: 'POST',
                        body: JSON.stringify({
                            message: message,
                            user_id: userId
                        })
                    });
                    
                    const fallbackResult = await fallbackResponse.json();
                    addMessage(fallbackResult.response || '系统处理完成');
                    updateStatus('处理完成 (传统模式)', 'success');
                    
                } catch (fallbackError) {
                    addMessage(`系统错误: ${fallbackError.message}. 请检查API服务是否正在运行`, false);
                    updateStatus('处理失败', 'error');
                }
                
            } finally {
                sendBtn.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        async function pollTaskStatus(taskId, progressDiv) {
            const maxPolls = 120; // 最多轮询2分钟 (120 * 1000ms)
            let pollCount = 0;
            
            const poll = async () => {
                try {
                    const statusResponse = await apiRequest(`${API_BASE_URL}/chat/task_status/${taskId}`);
                    
                    if (!statusResponse.ok) {
                        throw new Error(`Status check failed: ${statusResponse.status}`);
                    }
                    
                    const taskStatus = await statusResponse.json();
                    updateProgressDisplay(taskStatus, progressDiv);
                    
                    if (taskStatus.status === 'completed') {
                        // 任务完成，显示最终结果
                        messagesContainer.removeChild(progressDiv);
                        
                        const finalResult = taskStatus.final_result;
                        if (finalResult && finalResult.response) {
                            addMessage(finalResult.response);
                            
                            // 显示分析详情
                            if (finalResult.evidence_files && finalResult.evidence_files.length > 0) {
                                let evidenceMsg = '\n\n📋 **证据文件**:\n';
                                finalResult.evidence_files.forEach(file => {
                                    evidenceMsg += `- ${file.file_name} (行 ${file.line_number})\n`;
                                });
                                addMessage(evidenceMsg);
                            }
                            
                            // 显示拓扑信息
                            if (finalResult.topology_data && finalResult.topology_data.affected_services) {
                                let topoMsg = '\n\n🕸️ **服务拓扑**:\n';
                                topoMsg += `影响服务: ${finalResult.topology_data.affected_services.join(', ')}\n`;
                                addMessage(topoMsg);
                            }
                        } else {
                            addMessage('分析完成，但未返回详细结果');
                        }
                        
                        updateStatus(`分析完成 (${taskStatus.total_duration?.toFixed(2) || 'N/A'}s)`, 'success');
                        return;
                        
                    } else if (taskStatus.status === 'failed') {
                        // 任务失败
                        messagesContainer.removeChild(progressDiv);
                        addMessage(`分析失败: ${taskStatus.error || '未知错误'}`);
                        updateStatus('分析失败', 'error');
                        return;
                        
                    } else if (taskStatus.status === 'processing') {
                        // 继续轮询
                        pollCount++;
                        if (pollCount < maxPolls) {
                            setTimeout(poll, 500); // 每500ms轮询一次
                        } else {
                            // 超时
                            messagesContainer.removeChild(progressDiv);
                            addMessage('分析超时，请稍后重试');
                            updateStatus('分析超时', 'error');
                        }
                    }
                    
                } catch (error) {
                    console.error('Polling failed:', error);
                    messagesContainer.removeChild(progressDiv);
                    addMessage(`状态检查失败: ${error.message}`);
                    updateStatus('状态检查失败', 'error');
                }
            };
            
            // 开始轮询
            setTimeout(poll, 500);
        }

        function updateProgressDisplay(taskStatus, progressDiv) {
            const progressFill = progressDiv.querySelector('#progress-fill');
            const progressText = progressDiv.querySelector('#progress-text');
            const currentStage = progressDiv.querySelector('#current-stage');
            const stagesInfo = progressDiv.querySelector('#stages-info');
            
            // 更新进度条
            const progress = Math.round((taskStatus.progress || 0) * 100);
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `${progress}% 完成`;
            
            // 更新当前阶段
            currentStage.textContent = taskStatus.current_stage_detail || taskStatus.current_stage || '处理中...';
            
            // 更新各阶段状态
            if (taskStatus.stages_completed && stagesInfo) {
                const stageElements = stagesInfo.children;
                taskStatus.stages_completed.forEach((stage, index) => {
                    if (stageElements[index]) {
                        let emoji = '🔄';
                        if (stage.status === 'completed') emoji = '✅';
                        else if (stage.status === 'failed') emoji = '❌';
                        else if (stage.status === 'in_progress') emoji = '⏳';
                        
                        let duration = '';
                        if (stage.duration_ms) {
                            duration = ` (${stage.duration_ms}ms)`;
                        }
                        
                        stageElements[index].textContent = `${emoji} ${stage.stage}${duration}`;
                    }
                });
            }
            
            // 更新状态栏
            updateStatus(`${taskStatus.current_stage} (${progress}%)`, 'loading');
        }

        async function checkHealth() {
            updateStatus('检查系统状态...', 'loading');
            try {
                const response = await apiRequest(`${API_BASE_URL}/health`);
                const result = await response.json();
                
                let statusMsg = `系统状态: ${result.status}\\n`;
                if (result.components) {
                    statusMsg += '组件状态:\\n';
                    for (const [name, info] of Object.entries(result.components)) {
                        statusMsg += `- ${name}: ${info.status}\\n`;
                    }
                }
                
                addMessage(statusMsg, false);
                updateStatus('状态检查完成', 'success');
            } catch (error) {
                addMessage(`健康检查失败: ${error.message}`, false);
                updateStatus('检查失败', 'error');
            }
        }

        async function getStats() {
            updateStatus('获取数据统计...', 'loading');
            try {
                const response = await apiRequest(`${API_BASE_URL}/stats`);
                const result = await response.json();
                
                let statsMsg = '📊 系统数据统计:\\n';
                for (const [key, value] of Object.entries(result)) {
                    if (typeof value === 'object') {
                        statsMsg += `${key}:\\n`;
                        for (const [subKey, subValue] of Object.entries(value)) {
                            statsMsg += `  - ${subKey}: ${subValue}\\n`;
                        }
                    } else {
                        statsMsg += `${key}: ${value}\\n`;
                    }
                }
                
                addMessage(statsMsg, false);
                updateStatus('统计信息获取完成', 'success');
            } catch (error) {
                addMessage(`统计信息获取失败: ${error.message}`, false);
                updateStatus('获取失败', 'error');
            }
        }

        function searchKnowledge() {
            const query = prompt('请输入搜索关键词:');
            if (!query) return;
            
            updateStatus('搜索知识库...', 'loading');
            
            apiRequest(`${API_BASE_URL}/search`, {
                method: 'POST',
                body: JSON.stringify({
                    query: query,
                    search_type: 'hybrid',
                    limit: 5
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.documents && result.documents.length > 0) {
                    let searchResults = `🔍 搜索结果 "${query}":\\n\\n`;
                    result.documents.forEach((doc, index) => {
                        searchResults += `${index + 1}. 📄 ${doc.title || 'Untitled'}\\n`;
                        searchResults += `   📂 来源: ${doc.source || 'unknown'}\\n`;
                        const content = doc.content || '';
                        const shortContent = content.length > 150 ? content.substring(0, 150) + '...' : content;
                        searchResults += `   📝 内容: ${shortContent}\\n\\n`;
                    });
                    addMessage(searchResults, false);
                } else {
                    addMessage(`未找到关键词 "${query}" 的相关文档`, false);
                }
                updateStatus('搜索完成', 'success');
            })
            .catch(error => {
                addMessage(`搜索失败: ${error.message}`, false);
                updateStatus('搜索失败', 'error');
            });
        }

        function askExample(question) {
            messageInput.value = question;
            sendMessage();
        }

        function clearChat() {
            messagesContainer.innerHTML = '';
            updateStatus('对话已清空', 'success');
        }
        
        // Multi-Agent相关函数
        async function sendMultiAgentMessage(message) {
            // 创建Multi-Agent进度显示元素
            const progressDiv = document.createElement('div');
            progressDiv.className = 'message bot-message';
            progressDiv.innerHTML = createMultiAgentProgressHTML();
            messagesContainer.appendChild(progressDiv);
            
            try {
                updateStatus('启动Multi-Agent RCA分析...', 'loading');
                
                // 启动multi-agent任务
                const streamResponse = await apiRequest(`${API_BASE_URL}/chat/multi_agent`, {
                    method: 'POST',
                    body: JSON.stringify({
                        message: message,
                        user_id: userId
                    })
                });
                
                if (!streamResponse.ok) {
                    throw new Error(`HTTP ${streamResponse.status}: ${streamResponse.statusText}`);
                }
                
                const streamResult = await streamResponse.json();
                
                if (streamResult.success) {
                    currentTaskId = streamResult.task_id; // 设置当前任务ID
                    // 开始轮询Multi-Agent状态
                    await pollMultiAgentStatus(streamResult.task_id, progressDiv);
                } else {
                    throw new Error('Failed to start multi-agent task');
                }
                
            } catch (error) {
                console.error('Multi-Agent连接错误:', error);
                updateStatus('Multi-Agent连接失败，使用传统方式...', 'warning');
                
                // 回退到传统聊天
                progressDiv.remove();
                await sendTraditionalMessage(message);
            }
        }
        
        function createMultiAgentProgressHTML() {
            return `
                <strong>🤖 Multi-Agent分析系统:</strong><br>
                <div class="bot-content">
                    <div id="ma-progress-container" style="margin: 10px 0;">
                        <div style="background: #f0f0f0; border-radius: 10px; padding: 15px;">
                            <!-- 整体进度 -->
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                <div style="display: flex; align-items: center;">
                                    <div class="spinner" style="margin-right: 10px;"></div>
                                    <span id="ma-current-phase">规划阶段</span>
                                </div>
                                <button id="interrupt-btn" onclick="interruptTask()" 
                                        style="padding: 5px 12px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    中断任务
                                </button>
                            </div>
                            
                            <!-- 整体进度条 -->
                            <div id="ma-progress-bar" style="background: #e0e0e0; height: 12px; border-radius: 6px; margin: 10px 0;">
                                <div id="ma-progress-fill" style="background: #667eea; height: 100%; width: 0%; border-radius: 6px; transition: width 0.3s;"></div>
                            </div>
                            <div id="ma-progress-text">0% 完成</div>
                            
                            <!-- Planner规划展示 -->
                            <div id="planning-section" style="margin: 15px 0; padding: 10px; background: #e8f2ff; border-radius: 8px;">
                                <h4 style="margin: 0 0 10px 0; color: #2c5282;">📋 Planner Agent规划</h4>
                                <div id="planning-content">等待Planner制定执行计划...</div>
                            </div>
                            
                            <!-- Agents状态 -->
                            <div id="agents-section" style="margin: 15px 0;">
                                <h4 style="margin: 0 0 10px 0; color: #2c5282;">🤖 Agents协作状态</h4>
                                <div id="agents-status">
                                    <div class="agent-status" data-agent="planner">🧠 Planner Agent: <span class="status">等待中</span></div>
                                    <div class="agent-status" data-agent="knowledge">📚 Knowledge Agent: <span class="status">等待中</span></div>
                                    <div class="agent-status" data-agent="reasoning">🔍 Reasoning Agent: <span class="status">等待中</span></div>
                                    <div class="agent-status" data-agent="executor">⚡ Executor Agent: <span class="status">等待中</span></div>
                                </div>
                            </div>
                            
                            <!-- 中间结论 -->
                            <div id="conclusions-section" style="margin: 15px 0; display: none;">
                                <h4 style="margin: 0 0 10px 0; color: #2c5282;">📝 分析结论</h4>
                                <div id="conclusions-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function pollMultiAgentStatus(taskId, progressDiv) {
            currentTaskId = taskId; // 设置全局任务ID用于中断
            const maxPolls = 240; // 2分钟超时
            
            for (let i = 0; i < maxPolls; i++) {
                try {
                    const statusResponse = await apiRequest(`${API_BASE_URL}/chat/multi_agent_status/${currentTaskId}`);
                    
                    if (!statusResponse.ok) {
                        throw new Error(`Status check failed: ${statusResponse.status}`);
                    }
                    
                    const status = await statusResponse.json();
                    updateMultiAgentDisplay(status);
                    
                    if (status.status === 'completed') {
                        updateStatus('Multi-Agent分析完成', 'success');
                        displayMultiAgentResult(status, progressDiv);
                        break;
                    } else if (status.status === 'failed') {
                        updateStatus('Multi-Agent分析失败', 'error');
                        displayMultiAgentError(status, progressDiv);
                        break;
                    } else if (status.status === 'interrupted') {
                        updateStatus('任务已被中断', 'warning');
                        displayMultiAgentInterrupted(status, progressDiv);
                        break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error('轮询错误:', error);
                    updateStatus('状态查询失败，回退到传统模式', 'error');
                    progressDiv.remove();
                    await sendTraditionalMessage(messageInput.value || '分析请求');
                    break;
                }
            }
            
            // 恢复输入控制
            sendBtn.disabled = false;
            messageInput.disabled = false;
        }
        
        function updateMultiAgentDisplay(status) {
            // 更新整体进度
            const progressFill = document.getElementById('ma-progress-fill');
            const progressText = document.getElementById('ma-progress-text');
            const currentPhase = document.getElementById('ma-current-phase');
            
            if (progressFill) {
                progressFill.style.width = `${status.overall_progress * 100}%`;
            }
            if (progressText) {
                progressText.textContent = `${Math.round(status.overall_progress * 100)}% 完成`;
            }
            if (currentPhase) {
                currentPhase.textContent = status.current_phase === 'planning' ? '规划阶段' : 
                                         status.current_phase === 'execution' ? '执行阶段' : '完成阶段';
            }
            
            // 更新Planner规划内容
            updatePlanningDisplay(status.planning_sessions);
            
            // 更新Agents状态
            updateAgentsDisplay(status.agents);
            
            // 更新中间结论
            updateConclusionsDisplay(status.intermediate_conclusions);
        }
        
        function updatePlanningDisplay(planningSessions) {
            const planningContent = document.getElementById('planning-content');
            if (!planningContent || !planningSessions || planningSessions.length === 0) return;
            
            const latestSession = planningSessions[planningSessions.length - 1];
            
            if (latestSession.status === 'planning') {
                planningContent.innerHTML = '🤔 Planner正在分析问题，制定执行策略...';
            } else if (latestSession.status === 'completed') {
                let planHTML = `<div style="font-size: 0.9em;">`;
                planHTML += `<div style="margin-bottom: 8px;"><strong>推理过程:</strong></div>`;
                planHTML += `<div style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 10px;">${latestSession.reasoning || '规划完成'}</div>`;
                
                if (latestSession.steps && latestSession.steps.length > 0) {
                    planHTML += `<div style="margin-bottom: 8px;"><strong>执行步骤:</strong></div>`;
                    latestSession.steps.forEach((step, index) => {
                        const statusIcon = step.status === 'completed' ? '✅' : 
                                         step.status === 'executing' ? '🔄' : 
                                         step.status === 'failed' ? '❌' : '⏳';
                        planHTML += `<div style="margin: 4px 0; padding: 4px 8px; background: white; border-radius: 4px;">`;
                        planHTML += `${statusIcon} ${index + 1}. ${step.step_name} (${step.assigned_agent})`;
                        if (step.description) {
                            planHTML += `<br><small style="color: #666;">${step.description}</small>`;
                        }
                        planHTML += `</div>`;
                    });
                }
                planHTML += `</div>`;
                planningContent.innerHTML = planHTML;
            }
        }
        
        function updateAgentsDisplay(agents) {
            for (const [agentId, agentData] of Object.entries(agents)) {
                const agentElement = document.querySelector(`[data-agent="${agentId}"] .status`);
                if (!agentElement) continue;
                
                const statusMap = {
                    'waiting': '⏳ 等待中',
                    'working': '🔄 工作中',
                    'done': '✅ 完成',
                    'failed': '❌ 失败',
                    'interrupted': '⏸️ 中断'
                };
                
                let statusText = statusMap[agentData.status] || agentData.status;
                if (agentData.current_action && agentData.status === 'working') {
                    statusText += ` - ${agentData.current_action}`;
                }
                
                agentElement.innerHTML = statusText;
                
                // 更新颜色
                const agentDiv = agentElement.parentElement;
                agentDiv.style.color = agentData.status === 'done' ? '#059669' : 
                                     agentData.status === 'failed' ? '#dc2626' : 
                                     agentData.status === 'working' ? '#2563eb' : '#6b7280';
            }
        }
        
        function updateConclusionsDisplay(conclusions) {
            const conclusionsSection = document.getElementById('conclusions-section');
            const conclusionsContent = document.getElementById('conclusions-content');
            
            if (!conclusions || conclusions.length === 0) {
                conclusionsSection.style.display = 'none';
                return;
            }
            
            conclusionsSection.style.display = 'block';
            
            let conclusionsHTML = '';
            conclusions.forEach((conclusion, index) => {
                conclusionsHTML += `
                    <div style="margin: 8px 0; padding: 10px; background: white; border-radius: 6px; border-left: 4px solid #10b981;">
                        <div style="font-weight: bold; color: #065f46; margin-bottom: 4px;">
                            ${conclusion.agent_name} (置信度: ${Math.round(conclusion.confidence * 100)}%)
                        </div>
                        <div style="font-size: 0.9em;">
                            ${conclusion.conclusion}
                        </div>
                        <div style="font-size: 0.8em; color: #6b7280; margin-top: 4px;">
                            ${new Date(conclusion.timestamp).toLocaleTimeString()}
                        </div>
                    </div>
                `;
            });
            
            conclusionsContent.innerHTML = conclusionsHTML;
        }
        
        let currentTaskId = null;
        
        function interruptTask() {
            if (!currentTaskId) return;
            
            if (confirm('确定要中断当前的Multi-Agent分析任务吗？')) {
                fetch(`${API_BASE_URL}/chat/interrupt/${currentTaskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: '用户主动中断' })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        updateStatus('任务已中断', 'warning');
                    } else {
                        updateStatus('中断失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('中断请求失败:', error);
                    updateStatus('中断请求失败', 'error');
                });
            }
        }
        
        function displayMultiAgentResult(status, progressDiv) {
            const finalResult = status.final_result;
            const conclusions = status.intermediate_conclusions;
            
            let resultHTML = `
                <strong>🎯 Multi-Agent分析完成</strong><br>
                <div class="bot-content">
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 15px; margin: 10px 0;">
                        <!-- 执行摘要 -->
                        <div style="margin-bottom: 20px;">
                            <strong>📊 执行摘要:</strong><br>
                            涉及 ${finalResult.total_agents_involved} 个Agent，耗时 ${finalResult.execution_duration.toFixed(1)}秒<br>
                            整体置信度: ${Math.round(finalResult.confidence_score * 100)}%
                        </div>
                        
                        <!-- Planner规划过程 -->
                        <div style="margin-bottom: 20px;">
                            <strong>📋 Planner规划过程:</strong><br>
                            <div style="background: #e8f2ff; padding: 12px; border-radius: 6px; margin-top: 8px; font-size: 0.9em;">
                                ${status.planning_sessions[0].reasoning.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        
                        <!-- 各Agent详细结论 -->
                        <div style="margin-bottom: 20px;">
                            <strong>🤖 各Agent详细分析:</strong><br>
                            <div style="margin-top: 10px;">
            `;
            
            // 按Agent分组显示结论
            const agentConclusions = {};
            conclusions.forEach(conclusion => {
                if (!agentConclusions[conclusion.agent_id]) {
                    agentConclusions[conclusion.agent_id] = [];
                }
                agentConclusions[conclusion.agent_id].push(conclusion);
            });
            
            const agentNames = {
                'knowledge': '📚 Knowledge Agent',
                'reasoning': '🔍 Reasoning Agent', 
                'executor': '⚡ Executor Agent',
                'planner': '🧠 Planner Agent'
            };
            
            for (const [agentId, agentConcs] of Object.entries(agentConclusions)) {
                resultHTML += `
                    <div style="margin: 10px 0; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #3b82f6;">
                        <div style="font-weight: bold; color: #1e40af; margin-bottom: 8px;">
                            ${agentNames[agentId] || agentId}
                        </div>
                `;
                
                agentConcs.forEach(conclusion => {
                    resultHTML += `
                        <div style="margin: 6px 0; padding: 8px; background: #f8fafc; border-radius: 4px;">
                            <div style="font-size: 0.9em; margin-bottom: 4px;">
                                <strong>${conclusion.step_id}:</strong> ${conclusion.conclusion}
                            </div>
                            <div style="font-size: 0.8em; color: #6b7280;">
                                置信度: ${Math.round(conclusion.confidence * 100)}% | ${new Date(conclusion.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                });
                
                resultHTML += `</div>`;
            }
            
            resultHTML += `
                            </div>
                        </div>
                        
                        <!-- 最终分析结果 -->
                        <div style="margin-bottom: 20px;">
                            <strong>🔍 综合分析结果:</strong><br>
                            <div style="background: white; padding: 12px; border-radius: 6px; margin-top: 8px; border-left: 4px solid #10b981;">
                                ${finalResult.response.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        
                        <!-- 解决方案建议 -->
                        <div style="margin-bottom: 15px;">
                            <strong>💡 解决方案建议:</strong><br>
                            <div style="background: #fef3cd; padding: 12px; border-radius: 6px; margin-top: 8px; border-left: 4px solid #f59e0b;">
            `;
            
            // 从Executor Agent的结论中提取解决方案
            const executorConclusions = conclusions.filter(c => c.agent_id === 'executor');
            if (executorConclusions.length > 0) {
                const solutions = executorConclusions[0].conclusion;
                resultHTML += solutions.replace(/\n/g, '<br>');
            } else {
                resultHTML += '基于分析结果，建议监控相关服务状态并进行性能优化。';
            }
            
            resultHTML += `
                            </div>
                        </div>
                        
                        <!-- 证据详情 -->
                        <div style="margin-bottom: 20px;">
                            <strong>📋 证据收集详情:</strong><br>
                            <div style="background: #f1f5f9; padding: 12px; border-radius: 6px; margin-top: 8px; font-size: 0.9em;">
            `;
            
            // 显示详细证据信息
            if (finalResult.detailed_evidence) {
                const evidence = finalResult.detailed_evidence;
                
                // 显示RAG搜索结果
                if (evidence.rag_evidence && evidence.rag_evidence.length > 0) {
                    resultHTML += `
                        <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px; border-left: 3px solid #059669;">
                            <strong>🔍 RAG搜索证据 (${evidence.rag_evidence.length}条):</strong><br>
                    `;
                    
                    evidence.rag_evidence.slice(0, 5).forEach((item, index) => {
                        const content = item.content || '';
                        const sourceType = item.source_type || 'unknown';
                        const logFile = item.log_file || 'unknown_file';
                        const serviceName = item.service_name || 'unknown';
                        const timestamp = item.timestamp || '';
                        
                        // 根据source_type确定显示名称和图标
                        let displayName = logFile;
                        let icon = '📄';
                        if (sourceType === 'wiki') {
                            displayName = 'Wiki知识库';
                            icon = '📚';
                        } else if (sourceType === 'jira') {
                            displayName = 'JIRA工单系统';
                            icon = '🎫';
                        } else if (sourceType === 'gitlab') {
                            displayName = 'GitLab项目';
                            icon = '💻';
                        } else if (sourceType === 'logs') {
                            displayName = logFile;
                            icon = '📄';
                        }
                        
                        resultHTML += `
                            <div style="margin: 8px 0; padding: 8px; background: #f8fafc; border-radius: 3px; border-left: 2px solid #10b981;">
                                <div style="font-size: 0.85em; margin-bottom: 4px; font-weight: bold;">
                                    ${icon} ${displayName} 
                                    ${serviceName !== 'unknown' ? `| 服务: ${serviceName}` : ''}
                                    <span style="font-size: 0.75em; color: #6b7280; font-weight: normal;">(${sourceType})</span>
                                </div>
                                <div style="font-size: 0.8em; color: #374151; margin-bottom: 4px;">
                                    内容预览: ${content.substring(0, 200)}${content.length > 200 ? '...' : ''}
                                </div>
                                <div style="font-size: 0.75em; color: #6b7280;">
                                    时间: ${timestamp}
                                </div>
                            </div>
                        `;
                    });
                    
                    if (evidence.rag_evidence.length > 5) {
                        resultHTML += `<div style="font-size: 0.8em; color: #6b7280; margin-top: 8px;">... 还有 ${evidence.rag_evidence.length - 5} 条证据</div>`;
                    }
                    
                    resultHTML += `</div>`;
                }
                
                // 显示Neo4j拓扑信息
                if (evidence.topology_data && evidence.topology_data.relationships) {
                    const relationships = evidence.topology_data.relationships;
                    resultHTML += `
                        <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px; border-left: 3px solid #7c3aed;">
                            <strong>🗂️ 服务拓扑关系 (${relationships.length}个):</strong><br>
                    `;
                    
                    const uniqueServices = new Set();
                    relationships.forEach(rel => {
                        if (rel.from_service) uniqueServices.add(rel.from_service);
                        if (rel.to_service) uniqueServices.add(rel.to_service);
                    });
                    
                    resultHTML += `
                        <div style="margin: 8px 0; padding: 8px; background: #f8fafc; border-radius: 3px;">
                            <div style="font-size: 0.85em; margin-bottom: 4px; font-weight: bold;">
                                🏗️ 涉及服务: ${Array.from(uniqueServices).join(', ')}
                            </div>
                    `;
                    
                    relationships.slice(0, 5).forEach(rel => {
                        resultHTML += `
                            <div style="font-size: 0.8em; color: #374151; margin: 4px 0; padding-left: 16px;">
                                • ${rel.from_service || 'unknown'} → ${rel.to_service || 'unknown'} 
                                ${rel.relationship_type ? `(${rel.relationship_type})` : ''}
                            </div>
                        `;
                    });
                    
                    if (relationships.length > 5) {
                        resultHTML += `<div style="font-size: 0.8em; color: #6b7280; margin-top: 8px;">... 还有 ${relationships.length - 5} 个依赖关系</div>`;
                    }
                    
                    resultHTML += `</div></div>`;
                }
                
                // 显示数据源分析详情
                if (evidence.log_files_analyzed && evidence.log_files_analyzed.length > 0) {
                    resultHTML += `
                        <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px; border-left: 3px solid #ea580c;">
                            <strong>📋 数据源分析 (${evidence.log_files_analyzed.length}个数据源):</strong><br>
                    `;
                    
                    evidence.log_files_analyzed.forEach(dataSource => {
                        // 根据数据类型选择图标
                        let icon = '📄';
                        if (dataSource.data_type === '知识文档') icon = '📚';
                        else if (dataSource.data_type === '工单记录') icon = '🎫';
                        else if (dataSource.data_type === '代码仓库') icon = '💻';
                        else if (dataSource.data_type === '日志文件') icon = '📄';
                        
                        resultHTML += `
                            <div style="margin: 6px 0; padding: 6px; background: #f8fafc; border-radius: 3px;">
                                <div style="font-size: 0.85em; font-weight: bold; margin-bottom: 2px;">
                                    ${icon} ${dataSource.file_path} <span style="font-size: 0.75em; color: #6b7280; font-weight: normal;">(${dataSource.data_type})</span>
                                </div>
                                <div style="font-size: 0.8em; color: #6b7280; margin-bottom: 2px;">
                                    服务: ${dataSource.service}${dataSource.machine !== 'unknown' ? ` | 机器: ${dataSource.machine}` : ''}
                                </div>
                                <div style="font-size: 0.75em; color: #9ca3af;">
                                    时间: ${dataSource.timestamp} | 内容: ${dataSource.content_preview}
                                </div>
                            </div>
                        `;
                    });
                    
                    resultHTML += `</div>`;
                }
                
                resultHTML += `<div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-size: 0.9em; color: #374151;">${evidence.evidence_summary}</div>`;
            } else {
                // 从结论中提取证据信息（兼容旧格式）
                const evidenceConclusions = conclusions.filter(c => c.agent_id === 'knowledge');
                if (evidenceConclusions.length > 0) {
                    evidenceConclusions.forEach(evidence => {
                        resultHTML += `
                            <div style="margin: 6px 0;">
                                <strong>${evidence.step_id}:</strong> ${evidence.conclusion}
                            </div>
                        `;
                    });
                } else {
                    resultHTML += `<div>已完成实体识别、证据搜索和拓扑分析</div>`;
                }
            }
            
            resultHTML += `
                            </div>
                        </div>
                        
                        <!-- 推理过程详情 -->
                        <div style="margin-bottom: 20px;">
                            <strong>🧠 推理分析详情:</strong><br>
                            <div style="background: #fef7ff; padding: 12px; border-radius: 6px; margin-top: 8px; font-size: 0.9em; border-left: 4px solid #a855f7;">
            `;
            
            // 从结论中提取推理信息
            const reasoningConclusions = conclusions.filter(c => c.agent_id === 'reasoning');
            if (reasoningConclusions.length > 0) {
                reasoningConclusions.forEach(reasoning => {
                    resultHTML += `
                        <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px;">
                            <strong>分析方法:</strong> 多维度根因分析<br>
                            <strong>推理结论:</strong> ${reasoning.conclusion}<br>
                            <strong>置信度:</strong> ${Math.round(reasoning.confidence * 100)}%
                        </div>
                    `;
                });
            } else {
                resultHTML += `<div>已完成基于证据和拓扑信息的综合推理分析</div>`;
            }
            
            resultHTML += `
                            </div>
                        </div>
                        
                        <div style="font-size: 0.85em; color: #6b7280; border-top: 1px solid #e5e7eb; padding-top: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>分析完成时间: ${new Date().toLocaleString()}</span>
                                <span>Multi-Agent协作模式 | AIOps Polaris v2.0</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            progressDiv.innerHTML = resultHTML;
        }
        
        function displayMultiAgentError(status, progressDiv) {
            progressDiv.innerHTML = `
                <strong>❌ Multi-Agent分析失败</strong><br>
                <div class="bot-content">
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 15px; margin: 10px 0;">
                        错误信息: ${status.error || '未知错误'}
                    </div>
                </div>
            `;
        }
        
        function displayMultiAgentInterrupted(status, progressDiv) {
            progressDiv.innerHTML = `
                <strong>⏸️ 任务已中断</strong><br>
                <div class="bot-content">
                    <div style="background: #fefce8; border: 1px solid #fde047; border-radius: 8px; padding: 15px; margin: 10px 0;">
                        任务在 ${status.current_phase} 阶段被中断<br>
                        已完成进度: ${Math.round(status.overall_progress * 100)}%
                    </div>
                </div>
            `;
        }
        
        async function sendTraditionalMessage(message) {
            // 直接使用传统聊天API
            try {
                updateStatus('发送消息中...', 'loading');
                
                const response = await apiRequest(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    body: JSON.stringify({
                        message: message,
                        user_id: userId,
                        session_id: sessionId,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                addMessage(result.response || '无响应内容', false);
                updateStatus('响应完成', 'success');
                
            } catch (error) {
                console.error('传统聊天错误:', error);
                addMessage(`抱歉，发生了错误: ${error.message}`, false);
                updateStatus('发送失败', 'error');
            } finally {
                sendBtn.disabled = false;
                messageInput.disabled = false;
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // 页面加载时检查系统状态
        window.onload = function() {
            addMessage('欢迎使用AIOps Polaris智能运维助手！\\n\\n🔍 **RAG增强分析能力**:\\n- 基于234条向量索引 + 27个知识图谱节点\\n- 支持日志、Wiki、GitLab、Jira多源数据检索\\n- 智能根本原因分析(RCA)\\n\\n💡 **使用建议**:\\n- 描述具体的故障症状和服务名称\\n- 尝试右侧的RCA示例问题\\n- 可以询问服务依赖关系和解决方案', false);
            checkHealth();
        };
    </script>
</body>
</html>