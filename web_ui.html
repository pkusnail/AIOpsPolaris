<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIOps Polaris æ™ºèƒ½è¿ç»´åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 900px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin-bottom: 10px;
            font-size: 1.8em;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.9em;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            background: #f8f9fa;
            scroll-behavior: smooth;
            max-height: 60vh;
            min-height: 400px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 10px;
            max-width: 85%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
        }
        
        .user-message {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        
        .bot-message {
            background: #e9ecef;
            color: #333;
        }
        
        .bot-content {
            margin-top: 5px;
        }
        
        .bot-content h3 {
            color: #667eea;
            margin: 10px 0 5px 0;
            font-size: 1.1em;
        }
        
        .bot-content strong {
            color: #333;
        }
        
        .bot-content pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .message-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        .message-input:focus {
            border-color: #667eea;
        }
        
        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }
        
        .send-btn:hover {
            transform: translateY(-2px);
        }
        
        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-bar {
            padding: 10px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            font-size: 0.85em;
            color: #666;
        }
        
        .loading {
            color: #667eea;
            font-style: italic;
        }
        
        .error {
            color: #dc3545;
        }
        
        .success {
            color: #28a745;
        }

        .sidebar {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-width: 250px;
        }
        
        .sidebar h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1em;
        }
        
        .sidebar button {
            width: 100%;
            margin-bottom: 8px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .sidebar button:hover {
            background: #f8f9fa;
        }
        
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AIOps Polaris</h1>
            <p>åŸºäºRAG + æ··åˆæœç´¢ + å¤šAgentæ¶æ„çš„æ™ºèƒ½è¿ç»´åŠ©æ‰‹</p>
        </div>
        
        <div class="chat-container">
            <div class="messages" id="messages"></div>
            
            <div class="input-container">
                <input 
                    type="text" 
                    class="message-input" 
                    id="messageInput" 
                    placeholder="è¾“å…¥æ‚¨çš„è¿ç»´é—®é¢˜..."
                    onkeypress="handleKeyPress(event)"
                >
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">å‘é€</button>
            </div>
            
        </div>
        
        <div class="status-bar">
            <span id="statusText">ğŸŸ¢ ç³»ç»Ÿå·²è¿æ¥</span>
        </div>
    </div>

    <div class="sidebar">
        <h3>ğŸ”§ å¿«æ·æ“ä½œ</h3>
        <button onclick="checkHealth()">ğŸ” ç³»ç»ŸçŠ¶æ€</button>
        <button onclick="getStats()">ğŸ“Š æ•°æ®ç»Ÿè®¡</button>
        <button onclick="searchKnowledge()">ğŸ” æœç´¢çŸ¥è¯†åº“</button>
        <button onclick="clearChat()">ğŸ—‘ï¸ æ¸…ç©ºå¯¹è¯</button>
        
        <h3 style="margin-top: 15px;">ğŸ’¡ ç¤ºä¾‹é—®é¢˜</h3>
        <button onclick="askExample('service-b CPUä½¿ç”¨ç‡è¿‡é«˜ï¼Œå“åº”è¶…æ—¶ï¼Œè¯·åˆ†ææ ¹æœ¬åŸå› ')">Service-B CPUè¿‡è½½</button>
        <button onclick="askExample('service-d1 å†…å­˜æ³„æ¼é—®é¢˜ï¼Œè¯·å¸®æˆ‘åˆ†æ')">Service-D1å†…å­˜é—®é¢˜</button>
        <button onclick="askExample('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œå¤šä¸ªæœåŠ¡æ— æ³•è®¿é—®')">æ•°æ®åº“è¿æ¥é—®é¢˜</button>
        <button onclick="askExample('åˆ†æincident_001ä¸­çš„æ•…éšœæ ¹å› ')">åˆ†ææ—¥å¿—æ•…éšœ</button>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        // æ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨å¤„ç†CORS
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    mode: 'cors',
                    credentials: 'omit',
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        ...options.headers
                    }
                });
                return response;
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const statusText = document.getElementById('statusText');
        
        let userId = 'web_user_' + Date.now();

        function updateStatus(message, type = 'info') {
            const emoji = type === 'error' ? 'âŒ' : type === 'loading' ? 'ğŸ”„' : 'ğŸŸ¢';
            statusText.innerHTML = `${emoji} ${message}`;
            statusText.className = type;
        }

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ­£åœ¨æŸ¥çœ‹å†å²æ¶ˆæ¯
            const wasAtBottom = messagesContainer.scrollTop + messagesContainer.clientHeight >= messagesContainer.scrollHeight - 10;
            
            if (isUser) {
                messageDiv.innerHTML = `<strong>ğŸ‘¤ æ‚¨:</strong><br>${escapeHtml(content)}`;
            } else {
                // å¯¹äºæœºå™¨äººå›å¤ï¼Œæ”¯æŒç®€å•çš„Markdownæ ¼å¼
                const formattedContent = formatBotMessage(content);
                messageDiv.innerHTML = `<strong>ğŸ¤– AIOpsåŠ©æ‰‹:</strong><br><div class="bot-content">${formattedContent}</div>`;
            }
            
            messagesContainer.appendChild(messageDiv);
            
            // åªæœ‰å½“ç”¨æˆ·åœ¨åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨ï¼Œæˆ–è€…æ˜¯ç”¨æˆ·å‘é€çš„æ–°æ¶ˆæ¯
            if (wasAtBottom || isUser) {
                setTimeout(() => {
                    messagesContainer.scrollTo({
                        top: messagesContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }

        function formatBotMessage(content) {
            // è½¬æ¢ç®€å•çš„Markdownæ ¼å¼
            let formatted = escapeHtml(content);
            
            // å¤„ç†æ ‡é¢˜
            formatted = formatted.replace(/^## (.+)$/gm, '<h3 style="color: #667eea; margin: 10px 0 5px 0;">$1</h3>');
            formatted = formatted.replace(/^\*\*(.+)\*\*:/gm, '<strong style="color: #333;">$1:</strong>');
            
            // å¤„ç†åˆ—è¡¨
            formatted = formatted.replace(/^- (.+)$/gm, 'â€¢ $1<br>');
            formatted = formatted.replace(/^  â€¢ (.+)$/gm, '&nbsp;&nbsp;â€¢ $1<br>');
            
            // å¤„ç†ä»£ç å—
            formatted = formatted.replace(/```([^`]+)```/g, '<pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 10px 0; overflow-x: auto;">$1</pre>');
            
            // å¤„ç†æ¢è¡Œ
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // é˜²æ­¢é‡å¤å‘é€
            if (sendBtn.disabled) return;

            addMessage(message, true);
            messageInput.value = '';
            sendBtn.disabled = true;
            messageInput.disabled = true;
            
            // é»˜è®¤ä½¿ç”¨Multi-Agentæ¨¡å¼
            currentTaskId = null; // é‡ç½®å½“å‰ä»»åŠ¡ID
            return await sendMultiAgentMessage(message);
            
            // åˆ›å»ºè¿›åº¦æ˜¾ç¤ºå…ƒç´ 
            const progressDiv = document.createElement('div');
            progressDiv.className = 'message bot-message';
            progressDiv.innerHTML = `
                <strong>ğŸ¤– AIOpsåŠ©æ‰‹:</strong><br>
                <div class="bot-content">
                    <div id="progress-container" style="margin: 10px 0;">
                        <div style="background: #f0f0f0; border-radius: 10px; padding: 15px;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <div class="spinner" style="margin-right: 10px;"></div>
                                <span id="current-stage">æ­£åœ¨å¯åŠ¨RCAåˆ†æ...</span>
                            </div>
                            <div id="progress-bar" style="background: #e0e0e0; height: 8px; border-radius: 4px; margin: 10px 0;">
                                <div id="progress-fill" style="background: #667eea; height: 100%; width: 0%; border-radius: 4px; transition: width 0.3s;"></div>
                            </div>
                            <div id="progress-text">0% å®Œæˆ</div>
                            <div id="stages-info" style="margin-top: 10px; font-size: 0.85em; color: #666;">
                                <div>ğŸ”„ NERå®ä½“è¯†åˆ« - ç­‰å¾…ä¸­</div>
                                <div>ğŸ”„ æ··åˆæœç´¢ - ç­‰å¾…ä¸­</div>
                                <div>ğŸ”„ æ‹“æ‰‘æŸ¥è¯¢ - ç­‰å¾…ä¸­</div>
                                <div>ğŸ”„ Agentæ¨ç† - ç­‰å¾…ä¸­</div>
                                <div>ğŸ”„ ç»“æœæ ¼å¼åŒ– - ç­‰å¾…ä¸­</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(progressDiv);

            try {
                // é¦–å…ˆå¯åŠ¨æµå¼ä»»åŠ¡
                updateStatus('å¯åŠ¨RCAåˆ†æä»»åŠ¡...', 'loading');
                
                const streamResponse = await apiRequest(`${API_BASE_URL}/chat/stream`, {
                    method: 'POST',
                    body: JSON.stringify({
                        message: message,
                        user_id: userId,
                        temperature: 0.7
                    })
                });

                if (!streamResponse.ok) {
                    throw new Error(`HTTP ${streamResponse.status}: ${streamResponse.statusText}`);
                }

                const streamResult = await streamResponse.json();
                const taskId = streamResult.task_id;
                
                updateStatus(`ä»»åŠ¡å·²å¯åŠ¨ (ID: ${taskId.slice(-8)}), æ­£åœ¨åˆ†æ...`, 'loading');
                
                // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                await pollTaskStatus(taskId, progressDiv);
                
            } catch (error) {
                console.error('Streaming chat request failed:', error);
                
                // ç§»é™¤è¿›åº¦æ˜¾ç¤ºï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                messagesContainer.removeChild(progressDiv);
                addMessage(`è¿æ¥é”™è¯¯: ${error.message}. æ­£åœ¨å°è¯•ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼...`, false);
                
                // å›é€€åˆ°ä¼ ç»ŸèŠå¤©æ–¹å¼
                try {
                    updateStatus('ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼å¤„ç†...', 'loading');
                    const fallbackResponse = await apiRequest(`${API_BASE_URL}/chat`, {
                        method: 'POST',
                        body: JSON.stringify({
                            message: message,
                            user_id: userId
                        })
                    });
                    
                    const fallbackResult = await fallbackResponse.json();
                    addMessage(fallbackResult.response || 'ç³»ç»Ÿå¤„ç†å®Œæˆ');
                    updateStatus('å¤„ç†å®Œæˆ (ä¼ ç»Ÿæ¨¡å¼)', 'success');
                    
                } catch (fallbackError) {
                    addMessage(`ç³»ç»Ÿé”™è¯¯: ${fallbackError.message}. è¯·æ£€æŸ¥APIæœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ`, false);
                    updateStatus('å¤„ç†å¤±è´¥', 'error');
                }
                
            } finally {
                sendBtn.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        async function pollTaskStatus(taskId, progressDiv) {
            const maxPolls = 120; // æœ€å¤šè½®è¯¢2åˆ†é’Ÿ (120 * 1000ms)
            let pollCount = 0;
            
            const poll = async () => {
                try {
                    const statusResponse = await apiRequest(`${API_BASE_URL}/chat/task_status/${taskId}`);
                    
                    if (!statusResponse.ok) {
                        throw new Error(`Status check failed: ${statusResponse.status}`);
                    }
                    
                    const taskStatus = await statusResponse.json();
                    updateProgressDisplay(taskStatus, progressDiv);
                    
                    if (taskStatus.status === 'completed') {
                        // ä»»åŠ¡å®Œæˆï¼Œæ˜¾ç¤ºæœ€ç»ˆç»“æœ
                        messagesContainer.removeChild(progressDiv);
                        
                        const finalResult = taskStatus.final_result;
                        if (finalResult && finalResult.response) {
                            addMessage(finalResult.response);
                            
                            // æ˜¾ç¤ºåˆ†æè¯¦æƒ…
                            if (finalResult.evidence_files && finalResult.evidence_files.length > 0) {
                                let evidenceMsg = '\n\nğŸ“‹ **è¯æ®æ–‡ä»¶**:\n';
                                finalResult.evidence_files.forEach(file => {
                                    evidenceMsg += `- ${file.file_name} (è¡Œ ${file.line_number})\n`;
                                });
                                addMessage(evidenceMsg);
                            }
                            
                            // æ˜¾ç¤ºæ‹“æ‰‘ä¿¡æ¯
                            if (finalResult.topology_data && finalResult.topology_data.affected_services) {
                                let topoMsg = '\n\nğŸ•¸ï¸ **æœåŠ¡æ‹“æ‰‘**:\n';
                                topoMsg += `å½±å“æœåŠ¡: ${finalResult.topology_data.affected_services.join(', ')}\n`;
                                addMessage(topoMsg);
                            }
                        } else {
                            addMessage('åˆ†æå®Œæˆï¼Œä½†æœªè¿”å›è¯¦ç»†ç»“æœ');
                        }
                        
                        updateStatus(`åˆ†æå®Œæˆ (${taskStatus.total_duration?.toFixed(2) || 'N/A'}s)`, 'success');
                        return;
                        
                    } else if (taskStatus.status === 'failed') {
                        // ä»»åŠ¡å¤±è´¥
                        messagesContainer.removeChild(progressDiv);
                        addMessage(`åˆ†æå¤±è´¥: ${taskStatus.error || 'æœªçŸ¥é”™è¯¯'}`);
                        updateStatus('åˆ†æå¤±è´¥', 'error');
                        return;
                        
                    } else if (taskStatus.status === 'processing') {
                        // ç»§ç»­è½®è¯¢
                        pollCount++;
                        if (pollCount < maxPolls) {
                            setTimeout(poll, 500); // æ¯500msè½®è¯¢ä¸€æ¬¡
                        } else {
                            // è¶…æ—¶
                            messagesContainer.removeChild(progressDiv);
                            addMessage('åˆ†æè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
                            updateStatus('åˆ†æè¶…æ—¶', 'error');
                        }
                    }
                    
                } catch (error) {
                    console.error('Polling failed:', error);
                    messagesContainer.removeChild(progressDiv);
                    addMessage(`çŠ¶æ€æ£€æŸ¥å¤±è´¥: ${error.message}`);
                    updateStatus('çŠ¶æ€æ£€æŸ¥å¤±è´¥', 'error');
                }
            };
            
            // å¼€å§‹è½®è¯¢
            setTimeout(poll, 500);
        }

        function updateProgressDisplay(taskStatus, progressDiv) {
            const progressFill = progressDiv.querySelector('#progress-fill');
            const progressText = progressDiv.querySelector('#progress-text');
            const currentStage = progressDiv.querySelector('#current-stage');
            const stagesInfo = progressDiv.querySelector('#stages-info');
            
            // æ›´æ–°è¿›åº¦æ¡
            const progress = Math.round((taskStatus.progress || 0) * 100);
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `${progress}% å®Œæˆ`;
            
            // æ›´æ–°å½“å‰é˜¶æ®µ
            currentStage.textContent = taskStatus.current_stage_detail || taskStatus.current_stage || 'å¤„ç†ä¸­...';
            
            // æ›´æ–°å„é˜¶æ®µçŠ¶æ€
            if (taskStatus.stages_completed && stagesInfo) {
                const stageElements = stagesInfo.children;
                taskStatus.stages_completed.forEach((stage, index) => {
                    if (stageElements[index]) {
                        let emoji = 'ğŸ”„';
                        if (stage.status === 'completed') emoji = 'âœ…';
                        else if (stage.status === 'failed') emoji = 'âŒ';
                        else if (stage.status === 'in_progress') emoji = 'â³';
                        
                        let duration = '';
                        if (stage.duration_ms) {
                            duration = ` (${stage.duration_ms}ms)`;
                        }
                        
                        stageElements[index].textContent = `${emoji} ${stage.stage}${duration}`;
                    }
                });
            }
            
            // æ›´æ–°çŠ¶æ€æ 
            updateStatus(`${taskStatus.current_stage} (${progress}%)`, 'loading');
        }

        async function checkHealth() {
            updateStatus('æ£€æŸ¥ç³»ç»ŸçŠ¶æ€...', 'loading');
            try {
                const response = await apiRequest(`${API_BASE_URL}/health`);
                const result = await response.json();
                
                let statusMsg = `ç³»ç»ŸçŠ¶æ€: ${result.status}\\n`;
                if (result.components) {
                    statusMsg += 'ç»„ä»¶çŠ¶æ€:\\n';
                    for (const [name, info] of Object.entries(result.components)) {
                        statusMsg += `- ${name}: ${info.status}\\n`;
                    }
                }
                
                addMessage(statusMsg, false);
                updateStatus('çŠ¶æ€æ£€æŸ¥å®Œæˆ', 'success');
            } catch (error) {
                addMessage(`å¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}`, false);
                updateStatus('æ£€æŸ¥å¤±è´¥', 'error');
            }
        }

        async function getStats() {
            updateStatus('è·å–æ•°æ®ç»Ÿè®¡...', 'loading');
            try {
                const response = await apiRequest(`${API_BASE_URL}/stats`);
                const result = await response.json();
                
                let statsMsg = 'ğŸ“Š ç³»ç»Ÿæ•°æ®ç»Ÿè®¡:\\n';
                for (const [key, value] of Object.entries(result)) {
                    if (typeof value === 'object') {
                        statsMsg += `${key}:\\n`;
                        for (const [subKey, subValue] of Object.entries(value)) {
                            statsMsg += `  - ${subKey}: ${subValue}\\n`;
                        }
                    } else {
                        statsMsg += `${key}: ${value}\\n`;
                    }
                }
                
                addMessage(statsMsg, false);
                updateStatus('ç»Ÿè®¡ä¿¡æ¯è·å–å®Œæˆ', 'success');
            } catch (error) {
                addMessage(`ç»Ÿè®¡ä¿¡æ¯è·å–å¤±è´¥: ${error.message}`, false);
                updateStatus('è·å–å¤±è´¥', 'error');
            }
        }

        function searchKnowledge() {
            const query = prompt('è¯·è¾“å…¥æœç´¢å…³é”®è¯:');
            if (!query) return;
            
            updateStatus('æœç´¢çŸ¥è¯†åº“...', 'loading');
            
            apiRequest(`${API_BASE_URL}/search`, {
                method: 'POST',
                body: JSON.stringify({
                    query: query,
                    search_type: 'hybrid',
                    limit: 5
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.documents && result.documents.length > 0) {
                    let searchResults = `ğŸ” æœç´¢ç»“æœ "${query}":\\n\\n`;
                    result.documents.forEach((doc, index) => {
                        searchResults += `${index + 1}. ğŸ“„ ${doc.title || 'Untitled'}\\n`;
                        searchResults += `   ğŸ“‚ æ¥æº: ${doc.source || 'unknown'}\\n`;
                        const content = doc.content || '';
                        const shortContent = content.length > 150 ? content.substring(0, 150) + '...' : content;
                        searchResults += `   ğŸ“ å†…å®¹: ${shortContent}\\n\\n`;
                    });
                    addMessage(searchResults, false);
                } else {
                    addMessage(`æœªæ‰¾åˆ°å…³é”®è¯ "${query}" çš„ç›¸å…³æ–‡æ¡£`, false);
                }
                updateStatus('æœç´¢å®Œæˆ', 'success');
            })
            .catch(error => {
                addMessage(`æœç´¢å¤±è´¥: ${error.message}`, false);
                updateStatus('æœç´¢å¤±è´¥', 'error');
            });
        }

        function askExample(question) {
            messageInput.value = question;
            sendMessage();
        }

        function clearChat() {
            messagesContainer.innerHTML = '';
            updateStatus('å¯¹è¯å·²æ¸…ç©º', 'success');
        }
        
        // Multi-Agentç›¸å…³å‡½æ•°
        async function sendMultiAgentMessage(message) {
            // åˆ›å»ºMulti-Agentè¿›åº¦æ˜¾ç¤ºå…ƒç´ 
            const progressDiv = document.createElement('div');
            progressDiv.className = 'message bot-message';
            progressDiv.innerHTML = createMultiAgentProgressHTML();
            messagesContainer.appendChild(progressDiv);
            
            try {
                updateStatus('å¯åŠ¨Multi-Agent RCAåˆ†æ...', 'loading');
                
                // å¯åŠ¨multi-agentä»»åŠ¡
                const streamResponse = await apiRequest(`${API_BASE_URL}/chat/multi_agent`, {
                    method: 'POST',
                    body: JSON.stringify({
                        message: message,
                        user_id: userId
                    })
                });
                
                if (!streamResponse.ok) {
                    throw new Error(`HTTP ${streamResponse.status}: ${streamResponse.statusText}`);
                }
                
                const streamResult = await streamResponse.json();
                
                if (streamResult.success) {
                    currentTaskId = streamResult.task_id; // è®¾ç½®å½“å‰ä»»åŠ¡ID
                    // å¼€å§‹è½®è¯¢Multi-AgentçŠ¶æ€
                    await pollMultiAgentStatus(streamResult.task_id, progressDiv);
                } else {
                    throw new Error('Failed to start multi-agent task');
                }
                
            } catch (error) {
                console.error('Multi-Agentè¿æ¥é”™è¯¯:', error);
                updateStatus('Multi-Agentè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹å¼...', 'warning');
                
                // å›é€€åˆ°ä¼ ç»ŸèŠå¤©
                progressDiv.remove();
                await sendTraditionalMessage(message);
            }
        }
        
        function createMultiAgentProgressHTML() {
            return `
                <strong>ğŸ¤– Multi-Agentåˆ†æç³»ç»Ÿ:</strong><br>
                <div class="bot-content">
                    <div id="ma-progress-container" style="margin: 10px 0;">
                        <div style="background: #f0f0f0; border-radius: 10px; padding: 15px;">
                            <!-- æ•´ä½“è¿›åº¦ -->
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                                <div style="display: flex; align-items: center;">
                                    <div class="spinner" style="margin-right: 10px;"></div>
                                    <span id="ma-current-phase">è§„åˆ’é˜¶æ®µ</span>
                                </div>
                                <button id="interrupt-btn" onclick="interruptTask()" 
                                        style="padding: 5px 12px; background: #ff6b6b; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    ä¸­æ–­ä»»åŠ¡
                                </button>
                            </div>
                            
                            <!-- æ•´ä½“è¿›åº¦æ¡ -->
                            <div id="ma-progress-bar" style="background: #e0e0e0; height: 12px; border-radius: 6px; margin: 10px 0;">
                                <div id="ma-progress-fill" style="background: #667eea; height: 100%; width: 0%; border-radius: 6px; transition: width 0.3s;"></div>
                            </div>
                            <div id="ma-progress-text">0% å®Œæˆ</div>
                            
                            <!-- Plannerè§„åˆ’å±•ç¤º -->
                            <div id="planning-section" style="margin: 15px 0; padding: 10px; background: #e8f2ff; border-radius: 8px;">
                                <h4 style="margin: 0 0 10px 0; color: #2c5282;">ğŸ“‹ Planner Agentè§„åˆ’</h4>
                                <div id="planning-content">ç­‰å¾…Planneråˆ¶å®šæ‰§è¡Œè®¡åˆ’...</div>
                            </div>
                            
                            <!-- AgentsçŠ¶æ€ -->
                            <div id="agents-section" style="margin: 15px 0;">
                                <h4 style="margin: 0 0 10px 0; color: #2c5282;">ğŸ¤– Agentsåä½œçŠ¶æ€</h4>
                                <div id="agents-status">
                                    <div class="agent-status" data-agent="planner">ğŸ§  Planner Agent: <span class="status">ç­‰å¾…ä¸­</span></div>
                                    <div class="agent-status" data-agent="knowledge">ğŸ“š Knowledge Agent: <span class="status">ç­‰å¾…ä¸­</span></div>
                                    <div class="agent-status" data-agent="reasoning">ğŸ” Reasoning Agent: <span class="status">ç­‰å¾…ä¸­</span></div>
                                    <div class="agent-status" data-agent="executor">âš¡ Executor Agent: <span class="status">ç­‰å¾…ä¸­</span></div>
                                </div>
                            </div>
                            
                            <!-- ä¸­é—´ç»“è®º -->
                            <div id="conclusions-section" style="margin: 15px 0; display: none;">
                                <h4 style="margin: 0 0 10px 0; color: #2c5282;">ğŸ“ åˆ†æç»“è®º</h4>
                                <div id="conclusions-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function pollMultiAgentStatus(taskId, progressDiv) {
            currentTaskId = taskId; // è®¾ç½®å…¨å±€ä»»åŠ¡IDç”¨äºä¸­æ–­
            const maxPolls = 240; // 2åˆ†é’Ÿè¶…æ—¶
            
            for (let i = 0; i < maxPolls; i++) {
                try {
                    const statusResponse = await apiRequest(`${API_BASE_URL}/chat/multi_agent_status/${currentTaskId}`);
                    
                    if (!statusResponse.ok) {
                        throw new Error(`Status check failed: ${statusResponse.status}`);
                    }
                    
                    const status = await statusResponse.json();
                    updateMultiAgentDisplay(status);
                    
                    if (status.status === 'completed') {
                        updateStatus('Multi-Agentåˆ†æå®Œæˆ', 'success');
                        displayMultiAgentResult(status, progressDiv);
                        break;
                    } else if (status.status === 'failed') {
                        updateStatus('Multi-Agentåˆ†æå¤±è´¥', 'error');
                        displayMultiAgentError(status, progressDiv);
                        break;
                    } else if (status.status === 'interrupted') {
                        updateStatus('ä»»åŠ¡å·²è¢«ä¸­æ–­', 'warning');
                        displayMultiAgentInterrupted(status, progressDiv);
                        break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error('è½®è¯¢é”™è¯¯:', error);
                    updateStatus('çŠ¶æ€æŸ¥è¯¢å¤±è´¥ï¼Œå›é€€åˆ°ä¼ ç»Ÿæ¨¡å¼', 'error');
                    progressDiv.remove();
                    await sendTraditionalMessage(messageInput.value || 'åˆ†æè¯·æ±‚');
                    break;
                }
            }
            
            // æ¢å¤è¾“å…¥æ§åˆ¶
            sendBtn.disabled = false;
            messageInput.disabled = false;
        }
        
        function updateMultiAgentDisplay(status) {
            // æ›´æ–°æ•´ä½“è¿›åº¦
            const progressFill = document.getElementById('ma-progress-fill');
            const progressText = document.getElementById('ma-progress-text');
            const currentPhase = document.getElementById('ma-current-phase');
            
            if (progressFill) {
                progressFill.style.width = `${status.overall_progress * 100}%`;
            }
            if (progressText) {
                progressText.textContent = `${Math.round(status.overall_progress * 100)}% å®Œæˆ`;
            }
            if (currentPhase) {
                currentPhase.textContent = status.current_phase === 'planning' ? 'è§„åˆ’é˜¶æ®µ' : 
                                         status.current_phase === 'execution' ? 'æ‰§è¡Œé˜¶æ®µ' : 'å®Œæˆé˜¶æ®µ';
            }
            
            // æ›´æ–°Plannerè§„åˆ’å†…å®¹
            updatePlanningDisplay(status.planning_sessions);
            
            // æ›´æ–°AgentsçŠ¶æ€
            updateAgentsDisplay(status.agents);
            
            // æ›´æ–°ä¸­é—´ç»“è®º
            updateConclusionsDisplay(status.intermediate_conclusions);
        }
        
        function updatePlanningDisplay(planningSessions) {
            const planningContent = document.getElementById('planning-content');
            if (!planningContent || !planningSessions || planningSessions.length === 0) return;
            
            const latestSession = planningSessions[planningSessions.length - 1];
            
            if (latestSession.status === 'planning') {
                planningContent.innerHTML = 'ğŸ¤” Planneræ­£åœ¨åˆ†æé—®é¢˜ï¼Œåˆ¶å®šæ‰§è¡Œç­–ç•¥...';
            } else if (latestSession.status === 'completed') {
                let planHTML = `<div style="font-size: 0.9em;">`;
                planHTML += `<div style="margin-bottom: 8px;"><strong>æ¨ç†è¿‡ç¨‹:</strong></div>`;
                planHTML += `<div style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 10px;">${latestSession.reasoning || 'è§„åˆ’å®Œæˆ'}</div>`;
                
                if (latestSession.steps && latestSession.steps.length > 0) {
                    planHTML += `<div style="margin-bottom: 8px;"><strong>æ‰§è¡Œæ­¥éª¤:</strong></div>`;
                    latestSession.steps.forEach((step, index) => {
                        const statusIcon = step.status === 'completed' ? 'âœ…' : 
                                         step.status === 'executing' ? 'ğŸ”„' : 
                                         step.status === 'failed' ? 'âŒ' : 'â³';
                        planHTML += `<div style="margin: 4px 0; padding: 4px 8px; background: white; border-radius: 4px;">`;
                        planHTML += `${statusIcon} ${index + 1}. ${step.step_name} (${step.assigned_agent})`;
                        if (step.description) {
                            planHTML += `<br><small style="color: #666;">${step.description}</small>`;
                        }
                        planHTML += `</div>`;
                    });
                }
                planHTML += `</div>`;
                planningContent.innerHTML = planHTML;
            }
        }
        
        function updateAgentsDisplay(agents) {
            for (const [agentId, agentData] of Object.entries(agents)) {
                const agentElement = document.querySelector(`[data-agent="${agentId}"] .status`);
                if (!agentElement) continue;
                
                const statusMap = {
                    'waiting': 'â³ ç­‰å¾…ä¸­',
                    'working': 'ğŸ”„ å·¥ä½œä¸­',
                    'done': 'âœ… å®Œæˆ',
                    'failed': 'âŒ å¤±è´¥',
                    'interrupted': 'â¸ï¸ ä¸­æ–­'
                };
                
                let statusText = statusMap[agentData.status] || agentData.status;
                if (agentData.current_action && agentData.status === 'working') {
                    statusText += ` - ${agentData.current_action}`;
                }
                
                agentElement.innerHTML = statusText;
                
                // æ›´æ–°é¢œè‰²
                const agentDiv = agentElement.parentElement;
                agentDiv.style.color = agentData.status === 'done' ? '#059669' : 
                                     agentData.status === 'failed' ? '#dc2626' : 
                                     agentData.status === 'working' ? '#2563eb' : '#6b7280';
            }
        }
        
        function updateConclusionsDisplay(conclusions) {
            const conclusionsSection = document.getElementById('conclusions-section');
            const conclusionsContent = document.getElementById('conclusions-content');
            
            if (!conclusions || conclusions.length === 0) {
                conclusionsSection.style.display = 'none';
                return;
            }
            
            conclusionsSection.style.display = 'block';
            
            let conclusionsHTML = '';
            conclusions.forEach((conclusion, index) => {
                conclusionsHTML += `
                    <div style="margin: 8px 0; padding: 10px; background: white; border-radius: 6px; border-left: 4px solid #10b981;">
                        <div style="font-weight: bold; color: #065f46; margin-bottom: 4px;">
                            ${conclusion.agent_name} (ç½®ä¿¡åº¦: ${Math.round(conclusion.confidence * 100)}%)
                        </div>
                        <div style="font-size: 0.9em;">
                            ${conclusion.conclusion}
                        </div>
                        <div style="font-size: 0.8em; color: #6b7280; margin-top: 4px;">
                            ${new Date(conclusion.timestamp).toLocaleTimeString()}
                        </div>
                    </div>
                `;
            });
            
            conclusionsContent.innerHTML = conclusionsHTML;
        }
        
        let currentTaskId = null;
        
        function interruptTask() {
            if (!currentTaskId) return;
            
            if (confirm('ç¡®å®šè¦ä¸­æ–­å½“å‰çš„Multi-Agentåˆ†æä»»åŠ¡å—ï¼Ÿ')) {
                fetch(`${API_BASE_URL}/chat/interrupt/${currentTaskId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: 'ç”¨æˆ·ä¸»åŠ¨ä¸­æ–­' })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        updateStatus('ä»»åŠ¡å·²ä¸­æ–­', 'warning');
                    } else {
                        updateStatus('ä¸­æ–­å¤±è´¥', 'error');
                    }
                })
                .catch(error => {
                    console.error('ä¸­æ–­è¯·æ±‚å¤±è´¥:', error);
                    updateStatus('ä¸­æ–­è¯·æ±‚å¤±è´¥', 'error');
                });
            }
        }
        
        function displayMultiAgentResult(status, progressDiv) {
            const finalResult = status.final_result;
            const conclusions = status.intermediate_conclusions;
            
            let resultHTML = `
                <strong>ğŸ¯ Multi-Agentåˆ†æå®Œæˆ</strong><br>
                <div class="bot-content">
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 15px; margin: 10px 0;">
                        <!-- æ‰§è¡Œæ‘˜è¦ -->
                        <div style="margin-bottom: 20px;">
                            <strong>ğŸ“Š æ‰§è¡Œæ‘˜è¦:</strong><br>
                            æ¶‰åŠ ${finalResult.total_agents_involved} ä¸ªAgentï¼Œè€—æ—¶ ${finalResult.execution_duration.toFixed(1)}ç§’<br>
                            æ•´ä½“ç½®ä¿¡åº¦: ${Math.round(finalResult.confidence_score * 100)}%
                        </div>
                        
                        <!-- Plannerè§„åˆ’è¿‡ç¨‹ -->
                        <div style="margin-bottom: 20px;">
                            <strong>ğŸ“‹ Plannerè§„åˆ’è¿‡ç¨‹:</strong><br>
                            <div style="background: #e8f2ff; padding: 12px; border-radius: 6px; margin-top: 8px; font-size: 0.9em;">
                                ${status.planning_sessions[0].reasoning.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        
                        <!-- å„Agentè¯¦ç»†ç»“è®º -->
                        <div style="margin-bottom: 20px;">
                            <strong>ğŸ¤– å„Agentè¯¦ç»†åˆ†æ:</strong><br>
                            <div style="margin-top: 10px;">
            `;
            
            // æŒ‰Agentåˆ†ç»„æ˜¾ç¤ºç»“è®º
            const agentConclusions = {};
            conclusions.forEach(conclusion => {
                if (!agentConclusions[conclusion.agent_id]) {
                    agentConclusions[conclusion.agent_id] = [];
                }
                agentConclusions[conclusion.agent_id].push(conclusion);
            });
            
            const agentNames = {
                'knowledge': 'ğŸ“š Knowledge Agent',
                'reasoning': 'ğŸ” Reasoning Agent', 
                'executor': 'âš¡ Executor Agent',
                'planner': 'ğŸ§  Planner Agent'
            };
            
            for (const [agentId, agentConcs] of Object.entries(agentConclusions)) {
                resultHTML += `
                    <div style="margin: 10px 0; padding: 12px; background: white; border-radius: 6px; border-left: 4px solid #3b82f6;">
                        <div style="font-weight: bold; color: #1e40af; margin-bottom: 8px;">
                            ${agentNames[agentId] || agentId}
                        </div>
                `;
                
                agentConcs.forEach(conclusion => {
                    resultHTML += `
                        <div style="margin: 6px 0; padding: 8px; background: #f8fafc; border-radius: 4px;">
                            <div style="font-size: 0.9em; margin-bottom: 4px;">
                                <strong>${conclusion.step_id}:</strong> ${conclusion.conclusion}
                            </div>
                            <div style="font-size: 0.8em; color: #6b7280;">
                                ç½®ä¿¡åº¦: ${Math.round(conclusion.confidence * 100)}% | ${new Date(conclusion.timestamp).toLocaleTimeString()}
                            </div>
                        </div>
                    `;
                });
                
                resultHTML += `</div>`;
            }
            
            resultHTML += `
                            </div>
                        </div>
                        
                        <!-- æœ€ç»ˆåˆ†æç»“æœ -->
                        <div style="margin-bottom: 20px;">
                            <strong>ğŸ” ç»¼åˆåˆ†æç»“æœ:</strong><br>
                            <div style="background: white; padding: 12px; border-radius: 6px; margin-top: 8px; border-left: 4px solid #10b981;">
                                ${finalResult.response.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        
                        <!-- è§£å†³æ–¹æ¡ˆå»ºè®® -->
                        <div style="margin-bottom: 15px;">
                            <strong>ğŸ’¡ è§£å†³æ–¹æ¡ˆå»ºè®®:</strong><br>
                            <div style="background: #fef3cd; padding: 12px; border-radius: 6px; margin-top: 8px; border-left: 4px solid #f59e0b;">
            `;
            
            // ä»Executor Agentçš„ç»“è®ºä¸­æå–è§£å†³æ–¹æ¡ˆ
            const executorConclusions = conclusions.filter(c => c.agent_id === 'executor');
            if (executorConclusions.length > 0) {
                const solutions = executorConclusions[0].conclusion;
                resultHTML += solutions.replace(/\n/g, '<br>');
            } else {
                resultHTML += 'åŸºäºåˆ†æç»“æœï¼Œå»ºè®®ç›‘æ§ç›¸å…³æœåŠ¡çŠ¶æ€å¹¶è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚';
            }
            
            resultHTML += `
                            </div>
                        </div>
                        
                        <!-- è¯æ®è¯¦æƒ… -->
                        <div style="margin-bottom: 20px;">
                            <strong>ğŸ“‹ è¯æ®æ”¶é›†è¯¦æƒ…:</strong><br>
                            <div style="background: #f1f5f9; padding: 12px; border-radius: 6px; margin-top: 8px; font-size: 0.9em;">
            `;
            
            // æ˜¾ç¤ºè¯¦ç»†è¯æ®ä¿¡æ¯
            if (finalResult.detailed_evidence) {
                const evidence = finalResult.detailed_evidence;
                
                // æ˜¾ç¤ºRAGæœç´¢ç»“æœ
                if (evidence.rag_evidence && evidence.rag_evidence.length > 0) {
                    resultHTML += `
                        <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px; border-left: 3px solid #059669;">
                            <strong>ğŸ” RAGæœç´¢è¯æ® (${evidence.rag_evidence.length}æ¡):</strong><br>
                    `;
                    
                    evidence.rag_evidence.slice(0, 5).forEach((item, index) => {
                        const content = item.content || '';
                        const sourceType = item.source_type || 'unknown';
                        const logFile = item.log_file || 'unknown_file';
                        const serviceName = item.service_name || 'unknown';
                        const timestamp = item.timestamp || '';
                        
                        // æ ¹æ®source_typeç¡®å®šæ˜¾ç¤ºåç§°å’Œå›¾æ ‡
                        let displayName = logFile;
                        let icon = 'ğŸ“„';
                        if (sourceType === 'wiki') {
                            displayName = 'WikiçŸ¥è¯†åº“';
                            icon = 'ğŸ“š';
                        } else if (sourceType === 'jira') {
                            displayName = 'JIRAå·¥å•ç³»ç»Ÿ';
                            icon = 'ğŸ«';
                        } else if (sourceType === 'gitlab') {
                            displayName = 'GitLabé¡¹ç›®';
                            icon = 'ğŸ’»';
                        } else if (sourceType === 'logs') {
                            displayName = logFile;
                            icon = 'ğŸ“„';
                        }
                        
                        resultHTML += `
                            <div style="margin: 8px 0; padding: 8px; background: #f8fafc; border-radius: 3px; border-left: 2px solid #10b981;">
                                <div style="font-size: 0.85em; margin-bottom: 4px; font-weight: bold;">
                                    ${icon} ${displayName} 
                                    ${serviceName !== 'unknown' ? `| æœåŠ¡: ${serviceName}` : ''}
                                    <span style="font-size: 0.75em; color: #6b7280; font-weight: normal;">(${sourceType})</span>
                                </div>
                                <div style="font-size: 0.8em; color: #374151; margin-bottom: 4px;">
                                    å†…å®¹é¢„è§ˆ: ${content.substring(0, 200)}${content.length > 200 ? '...' : ''}
                                </div>
                                <div style="font-size: 0.75em; color: #6b7280;">
                                    æ—¶é—´: ${timestamp}
                                </div>
                            </div>
                        `;
                    });
                    
                    if (evidence.rag_evidence.length > 5) {
                        resultHTML += `<div style="font-size: 0.8em; color: #6b7280; margin-top: 8px;">... è¿˜æœ‰ ${evidence.rag_evidence.length - 5} æ¡è¯æ®</div>`;
                    }
                    
                    resultHTML += `</div>`;
                }
                
                // æ˜¾ç¤ºNeo4jæ‹“æ‰‘ä¿¡æ¯
                if (evidence.topology_data && evidence.topology_data.relationships) {
                    const relationships = evidence.topology_data.relationships;
                    resultHTML += `
                        <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px; border-left: 3px solid #7c3aed;">
                            <strong>ğŸ—‚ï¸ æœåŠ¡æ‹“æ‰‘å…³ç³» (${relationships.length}ä¸ª):</strong><br>
                    `;
                    
                    const uniqueServices = new Set();
                    relationships.forEach(rel => {
                        if (rel.from_service) uniqueServices.add(rel.from_service);
                        if (rel.to_service) uniqueServices.add(rel.to_service);
                    });
                    
                    resultHTML += `
                        <div style="margin: 8px 0; padding: 8px; background: #f8fafc; border-radius: 3px;">
                            <div style="font-size: 0.85em; margin-bottom: 4px; font-weight: bold;">
                                ğŸ—ï¸ æ¶‰åŠæœåŠ¡: ${Array.from(uniqueServices).join(', ')}
                            </div>
                    `;
                    
                    relationships.slice(0, 5).forEach(rel => {
                        resultHTML += `
                            <div style="font-size: 0.8em; color: #374151; margin: 4px 0; padding-left: 16px;">
                                â€¢ ${rel.from_service || 'unknown'} â†’ ${rel.to_service || 'unknown'} 
                                ${rel.relationship_type ? `(${rel.relationship_type})` : ''}
                            </div>
                        `;
                    });
                    
                    if (relationships.length > 5) {
                        resultHTML += `<div style="font-size: 0.8em; color: #6b7280; margin-top: 8px;">... è¿˜æœ‰ ${relationships.length - 5} ä¸ªä¾èµ–å…³ç³»</div>`;
                    }
                    
                    resultHTML += `</div></div>`;
                }
                
                // æ˜¾ç¤ºæ•°æ®æºåˆ†æè¯¦æƒ…
                if (evidence.log_files_analyzed && evidence.log_files_analyzed.length > 0) {
                    resultHTML += `
                        <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px; border-left: 3px solid #ea580c;">
                            <strong>ğŸ“‹ æ•°æ®æºåˆ†æ (${evidence.log_files_analyzed.length}ä¸ªæ•°æ®æº):</strong><br>
                    `;
                    
                    evidence.log_files_analyzed.forEach(dataSource => {
                        // æ ¹æ®æ•°æ®ç±»å‹é€‰æ‹©å›¾æ ‡
                        let icon = 'ğŸ“„';
                        if (dataSource.data_type === 'çŸ¥è¯†æ–‡æ¡£') icon = 'ğŸ“š';
                        else if (dataSource.data_type === 'å·¥å•è®°å½•') icon = 'ğŸ«';
                        else if (dataSource.data_type === 'ä»£ç ä»“åº“') icon = 'ğŸ’»';
                        else if (dataSource.data_type === 'æ—¥å¿—æ–‡ä»¶') icon = 'ğŸ“„';
                        
                        resultHTML += `
                            <div style="margin: 6px 0; padding: 6px; background: #f8fafc; border-radius: 3px;">
                                <div style="font-size: 0.85em; font-weight: bold; margin-bottom: 2px;">
                                    ${icon} ${dataSource.file_path} <span style="font-size: 0.75em; color: #6b7280; font-weight: normal;">(${dataSource.data_type})</span>
                                </div>
                                <div style="font-size: 0.8em; color: #6b7280; margin-bottom: 2px;">
                                    æœåŠ¡: ${dataSource.service}${dataSource.machine !== 'unknown' ? ` | æœºå™¨: ${dataSource.machine}` : ''}
                                </div>
                                <div style="font-size: 0.75em; color: #9ca3af;">
                                    æ—¶é—´: ${dataSource.timestamp} | å†…å®¹: ${dataSource.content_preview}
                                </div>
                            </div>
                        `;
                    });
                    
                    resultHTML += `</div>`;
                }
                
                resultHTML += `<div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-size: 0.9em; color: #374151;">${evidence.evidence_summary}</div>`;
            } else {
                // ä»ç»“è®ºä¸­æå–è¯æ®ä¿¡æ¯ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
                const evidenceConclusions = conclusions.filter(c => c.agent_id === 'knowledge');
                if (evidenceConclusions.length > 0) {
                    evidenceConclusions.forEach(evidence => {
                        resultHTML += `
                            <div style="margin: 6px 0;">
                                <strong>${evidence.step_id}:</strong> ${evidence.conclusion}
                            </div>
                        `;
                    });
                } else {
                    resultHTML += `<div>å·²å®Œæˆå®ä½“è¯†åˆ«ã€è¯æ®æœç´¢å’Œæ‹“æ‰‘åˆ†æ</div>`;
                }
            }
            
            resultHTML += `
                            </div>
                        </div>
                        
                        <!-- æ¨ç†è¿‡ç¨‹è¯¦æƒ… -->
                        <div style="margin-bottom: 20px;">
                            <strong>ğŸ§  æ¨ç†åˆ†æè¯¦æƒ…:</strong><br>
                            <div style="background: #fef7ff; padding: 12px; border-radius: 6px; margin-top: 8px; font-size: 0.9em; border-left: 4px solid #a855f7;">
            `;
            
            // ä»ç»“è®ºä¸­æå–æ¨ç†ä¿¡æ¯
            const reasoningConclusions = conclusions.filter(c => c.agent_id === 'reasoning');
            if (reasoningConclusions.length > 0) {
                reasoningConclusions.forEach(reasoning => {
                    resultHTML += `
                        <div style="margin: 8px 0; padding: 8px; background: white; border-radius: 4px;">
                            <strong>åˆ†ææ–¹æ³•:</strong> å¤šç»´åº¦æ ¹å› åˆ†æ<br>
                            <strong>æ¨ç†ç»“è®º:</strong> ${reasoning.conclusion}<br>
                            <strong>ç½®ä¿¡åº¦:</strong> ${Math.round(reasoning.confidence * 100)}%
                        </div>
                    `;
                });
            } else {
                resultHTML += `<div>å·²å®ŒæˆåŸºäºè¯æ®å’Œæ‹“æ‰‘ä¿¡æ¯çš„ç»¼åˆæ¨ç†åˆ†æ</div>`;
            }
            
            resultHTML += `
                            </div>
                        </div>
                        
                        <div style="font-size: 0.85em; color: #6b7280; border-top: 1px solid #e5e7eb; padding-top: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>åˆ†æå®Œæˆæ—¶é—´: ${new Date().toLocaleString()}</span>
                                <span>Multi-Agentåä½œæ¨¡å¼ | AIOps Polaris v2.0</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            progressDiv.innerHTML = resultHTML;
        }
        
        function displayMultiAgentError(status, progressDiv) {
            progressDiv.innerHTML = `
                <strong>âŒ Multi-Agentåˆ†æå¤±è´¥</strong><br>
                <div class="bot-content">
                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 15px; margin: 10px 0;">
                        é”™è¯¯ä¿¡æ¯: ${status.error || 'æœªçŸ¥é”™è¯¯'}
                    </div>
                </div>
            `;
        }
        
        function displayMultiAgentInterrupted(status, progressDiv) {
            progressDiv.innerHTML = `
                <strong>â¸ï¸ ä»»åŠ¡å·²ä¸­æ–­</strong><br>
                <div class="bot-content">
                    <div style="background: #fefce8; border: 1px solid #fde047; border-radius: 8px; padding: 15px; margin: 10px 0;">
                        ä»»åŠ¡åœ¨ ${status.current_phase} é˜¶æ®µè¢«ä¸­æ–­<br>
                        å·²å®Œæˆè¿›åº¦: ${Math.round(status.overall_progress * 100)}%
                    </div>
                </div>
            `;
        }
        
        async function sendTraditionalMessage(message) {
            // ç›´æ¥ä½¿ç”¨ä¼ ç»ŸèŠå¤©API
            try {
                updateStatus('å‘é€æ¶ˆæ¯ä¸­...', 'loading');
                
                const response = await apiRequest(`${API_BASE_URL}/chat`, {
                    method: 'POST',
                    body: JSON.stringify({
                        message: message,
                        user_id: userId,
                        session_id: sessionId,
                        temperature: 0.7
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                addMessage(result.response || 'æ— å“åº”å†…å®¹', false);
                updateStatus('å“åº”å®Œæˆ', 'success');
                
            } catch (error) {
                console.error('ä¼ ç»ŸèŠå¤©é”™è¯¯:', error);
                addMessage(`æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯: ${error.message}`, false);
                updateStatus('å‘é€å¤±è´¥', 'error');
            } finally {
                sendBtn.disabled = false;
                messageInput.disabled = false;
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        window.onload = function() {
            addMessage('æ¬¢è¿ä½¿ç”¨AIOps Polarisæ™ºèƒ½è¿ç»´åŠ©æ‰‹ï¼\\n\\nğŸ” **RAGå¢å¼ºåˆ†æèƒ½åŠ›**:\\n- åŸºäº234æ¡å‘é‡ç´¢å¼• + 27ä¸ªçŸ¥è¯†å›¾è°±èŠ‚ç‚¹\\n- æ”¯æŒæ—¥å¿—ã€Wikiã€GitLabã€Jiraå¤šæºæ•°æ®æ£€ç´¢\\n- æ™ºèƒ½æ ¹æœ¬åŸå› åˆ†æ(RCA)\\n\\nğŸ’¡ **ä½¿ç”¨å»ºè®®**:\\n- æè¿°å…·ä½“çš„æ•…éšœç—‡çŠ¶å’ŒæœåŠ¡åç§°\\n- å°è¯•å³ä¾§çš„RCAç¤ºä¾‹é—®é¢˜\\n- å¯ä»¥è¯¢é—®æœåŠ¡ä¾èµ–å…³ç³»å’Œè§£å†³æ–¹æ¡ˆ', false);
            checkHealth();
        };
    </script>
</body>
</html>